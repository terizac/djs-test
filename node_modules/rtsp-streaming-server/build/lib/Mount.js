"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Mount = void 0;

var _uuid = require("uuid");

var _RtpUdp = require("./RtpUdp");

var _utils = require("./utils");

const debug = (0, _utils.getDebugger)('Mount');

class Mount {
  constructor(mounts, path, sdpBody, hooks) {
    this.id = (0, _uuid.v4)();
    this.mounts = mounts;
    this.path = path;
    this.streams = {};
    this.hooks = hooks;
    this.sdp = sdpBody;
    debug('Set up mount at path %s', path);
  }

  createStream(uri) {
    const info = (0, _utils.getMountInfo)(uri);
    const nextPort = this.mounts.getNextRtpPort();

    if (!nextPort) {
      throw new Error('No ports available to create the stream');
    }

    debug('Setting up stream %s on path %s', info.streamId, info.path);
    this.streams[info.streamId] = {
      clients: {},
      id: info.streamId,
      mount: this,
      rtpEndPort: nextPort + 1,
      // RTCP
      rtpStartPort: nextPort // RTP

    };
    return this.streams[info.streamId];
  }

  async setup() {
    let portError = false;

    for (let id in this.streams) {
      let stream = this.streams[id];
      stream.listenerRtp = new _RtpUdp.RtpUdp(stream.rtpStartPort, stream);
      stream.listenerRtcp = new _RtpUdp.RtpUdp(stream.rtpEndPort, stream);

      try {
        await stream.listenerRtp.listen();
        await stream.listenerRtcp.listen();
      } catch (e) {
        // One or two of the ports was in use, cycle them out and try another
        if (e.errno && e.errno === 'EADDRINUSE') {
          console.warn(`Port error on ${e.port}, for stream ${stream.id} using another port`);
          portError = true;

          try {
            await stream.listenerRtp.close();
            await stream.listenerRtcp.close();
          } catch (e) {
            // Ignore, dont care if couldnt close
            console.log(e);
          }

          this.mounts.returnRtpPortToPool(stream.rtpStartPort);
          const nextStartPort = this.mounts.getNextRtpPort();

          if (!nextStartPort) {
            throw new Error('Unable to get another start port');
          }

          stream.rtpStartPort = nextStartPort;
          stream.rtpEndPort = stream.rtpEndPort + 1;
          break;
        }

        return e;
      }
    }

    if (portError) {
      return this.setup();
    }
  }

  close() {
    let ports = [];

    for (let id in this.streams) {
      const stream = this.streams[id];

      if (stream) {
        for (let id in stream.clients) {
          const client = stream.clients[id];
          console.log('Closing Client', client.id);
          client.close();
        }

        stream.listenerRtp && stream.listenerRtp.close();
        stream.listenerRtcp && stream.listenerRtcp.close();
      }

      ports.push(stream.rtpStartPort);
    }

    return ports;
  }

  clientLeave(client) {
    delete this.streams[client.stream.id].clients[client.id];
    let empty = true;

    for (let stream in this.streams) {
      if (Object.keys(this.streams[stream].clients).length > 0) {
        empty = false;
      }
    }

    if (empty === true && this.hooks && this.hooks.mountNowEmpty) {
      this.hooks.mountNowEmpty(this);
    }
  }

}

exports.Mount = Mount;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvTW91bnQudHMiXSwibmFtZXMiOlsiZGVidWciLCJNb3VudCIsImNvbnN0cnVjdG9yIiwibW91bnRzIiwicGF0aCIsInNkcEJvZHkiLCJob29rcyIsImlkIiwic3RyZWFtcyIsInNkcCIsImNyZWF0ZVN0cmVhbSIsInVyaSIsImluZm8iLCJuZXh0UG9ydCIsImdldE5leHRSdHBQb3J0IiwiRXJyb3IiLCJzdHJlYW1JZCIsImNsaWVudHMiLCJtb3VudCIsInJ0cEVuZFBvcnQiLCJydHBTdGFydFBvcnQiLCJzZXR1cCIsInBvcnRFcnJvciIsInN0cmVhbSIsImxpc3RlbmVyUnRwIiwiUnRwVWRwIiwibGlzdGVuZXJSdGNwIiwibGlzdGVuIiwiZSIsImVycm5vIiwiY29uc29sZSIsIndhcm4iLCJwb3J0IiwiY2xvc2UiLCJsb2ciLCJyZXR1cm5SdHBQb3J0VG9Qb29sIiwibmV4dFN0YXJ0UG9ydCIsInBvcnRzIiwiY2xpZW50IiwicHVzaCIsImNsaWVudExlYXZlIiwiZW1wdHkiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwibW91bnROb3dFbXB0eSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUtBOztBQUNBOztBQUVBLE1BQU1BLEtBQUssR0FBRyx3QkFBWSxPQUFaLENBQWQ7O0FBWU8sTUFBTUMsS0FBTixDQUFZO0FBYWpCQyxFQUFBQSxXQUFXLENBQUVDLE1BQUYsRUFBa0JDLElBQWxCLEVBQWdDQyxPQUFoQyxFQUFpREMsS0FBakQsRUFBbUY7QUFDNUYsU0FBS0MsRUFBTCxHQUFVLGVBQVY7QUFDQSxTQUFLSixNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLSSxPQUFMLEdBQWUsRUFBZjtBQUVBLFNBQUtGLEtBQUwsR0FBYUEsS0FBYjtBQUVBLFNBQUtHLEdBQUwsR0FBV0osT0FBWDtBQUVBTCxJQUFBQSxLQUFLLENBQUMseUJBQUQsRUFBNEJJLElBQTVCLENBQUw7QUFDRDs7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QUFHLEtBQVI7QUFDRDtBQUNGOztBQUVELFFBQUlBLEtBQUssS0FBSyxJQUFWLElBQWtCLEtBQUtuQyxLQUF2QixJQUFnQyxLQUFLQSxLQUFMLENBQVd1QyxhQUEvQyxFQUE4RDtBQUM1RCxXQUFLdkMsS0FBTCxDQUFXdUMsYUFBWCxDQUF5QixJQUF6QjtBQUNEO0FBQ0Y7O0FBaklnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHY0IGFzIHV1aWQgfSBmcm9tICd1dWlkJztcblxuaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSAnLi9DbGllbnQnO1xuaW1wb3J0IHsgTW91bnRzIH0gZnJvbSAnLi9Nb3VudHMnO1xuaW1wb3J0IHsgUHVibGlzaFNlcnZlckhvb2tzQ29uZmlnIH0gZnJvbSAnLi9QdWJsaXNoU2VydmVyJztcbmltcG9ydCB7IFJ0cFVkcCB9IGZyb20gJy4vUnRwVWRwJztcbmltcG9ydCB7IGdldERlYnVnZ2VyLCBnZXRNb3VudEluZm8gfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgZGVidWcgPSBnZXREZWJ1Z2dlcignTW91bnQnKTtcblxuZXhwb3J0IHR5cGUgUnRzcFN0cmVhbSA9IHtcbiAgaWQ6IG51bWJlcjsgLy8gTm90IGEgVVVJRCwgdGhpcyBpcyB0aGUgc3RyZWFtSWQgaW4gdGhlIFJUU1Agc3BlY1xuICBtb3VudDogTW91bnQ7XG4gIGNsaWVudHM6IHsgW2NsaWVudElkOiBzdHJpbmddOiBDbGllbnQgfTtcbiAgbGlzdGVuZXJSdHA/OiBSdHBVZHA7XG4gIGxpc3RlbmVyUnRjcD86IFJ0cFVkcDtcbiAgcnRwU3RhcnRQb3J0OiBudW1iZXI7XG4gIHJ0cEVuZFBvcnQ6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBjbGFzcyBNb3VudCB7XG4gIGlkOiBzdHJpbmc7XG4gIG1vdW50czogTW91bnRzO1xuICBwYXRoOiBzdHJpbmc7XG4gIHN0cmVhbXM6IHtcbiAgICBbc3RyZWFtSWQ6IG51bWJlcl06IFJ0c3BTdHJlYW0gLy8gVGhpcyBpcyB0aGUgUlRTUCBzdHJlYW1JZCBOdW1iZXIsIG5vdCBhIFVVSURcbiAgfTtcblxuICBzZHA6IHN0cmluZztcbiAgcmFuZ2U/OiBzdHJpbmc7XG5cbiAgaG9va3M/OiBQdWJsaXNoU2VydmVySG9va3NDb25maWc7XG5cbiAgY29uc3RydWN0b3IgKG1vdW50czogTW91bnRzLCBwYXRoOiBzdHJpbmcsIHNkcEJvZHk6IHN0cmluZywgaG9va3M/OiBQdWJsaXNoU2VydmVySG9va3NDb25maWcpIHtcbiAgICB0aGlzLmlkID0gdXVpZCgpO1xuICAgIHRoaXMubW91bnRzID0gbW91bnRzO1xuICAgIHRoaXMucGF0aCA9IHBhdGg7XG4gICAgdGhpcy5zdHJlYW1zID0ge307XG5cbiAgICB0aGlzLmhvb2tzID0gaG9va3M7XG5cbiAgICB0aGlzLnNkcCA9IHNkcEJvZHk7XG5cbiAgICBkZWJ1ZygnU2V0IHVwIG1vdW50IGF0IHBhdGggJXMnLCBwYXRoKTtcbiAgfVxuXG4gIGNyZWF0ZVN0cmVhbSAodXJpOiBzdHJpbmcpIHtcbiAgICBjb25zdCBpbmZvID0gZ2V0TW91bnRJbmZvKHVyaSk7XG5cbiAgICBjb25zdCBuZXh0UG9ydCA9IHRoaXMubW91bnRzLmdldE5leHRSdHBQb3J0KCk7XG5cbiAgICBpZiAoIW5leHRQb3J0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHBvcnRzIGF2YWlsYWJsZSB0byBjcmVhdGUgdGhlIHN0cmVhbScpO1xuICAgIH1cblxuICAgIGRlYnVnKCdTZXR0aW5nIHVwIHN0cmVhbSAlcyBvbiBwYXRoICVzJywgaW5mby5zdHJlYW1JZCwgaW5mby5wYXRoKTtcblxuICAgIHRoaXMuc3RyZWFtc1tpbmZvLnN0cmVhbUlkXSA9IHtcbiAgICAgIGNsaWVudHM6IHt9LFxuICAgICAgaWQ6IGluZm8uc3RyZWFtSWQsXG4gICAgICBtb3VudDogdGhpcyxcbiAgICAgIHJ0cEVuZFBvcnQ6IG5leHRQb3J0ICsgMSwgLy8gUlRDUFxuICAgICAgcnRwU3RhcnRQb3J0OiBuZXh0UG9ydCAvLyBSVFBcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuc3RyZWFtc1tpbmZvLnN0cmVhbUlkXTtcblxuICB9XG5cbiAgYXN5bmMgc2V0dXAgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGxldCBwb3J0RXJyb3IgPSBmYWxzZTtcblxuICAgIGZvciAobGV0IGlkIGluIHRoaXMuc3RyZWFtcykge1xuICAgICAgbGV0IHN0cmVhbSA9IHRoaXMuc3RyZWFtc1tpZF07XG5cbiAgICAgIHN0cmVhbS5saXN0ZW5lclJ0cCA9IG5ldyBSdHBVZHAoc3RyZWFtLnJ0cFN0YXJ0UG9ydCwgc3RyZWFtKTtcbiAgICAgIHN0cmVhbS5saXN0ZW5lclJ0Y3AgPSBuZXcgUnRwVWRwKHN0cmVhbS5ydHBFbmRQb3J0LCBzdHJlYW0pO1xuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzdHJlYW0ubGlzdGVuZXJSdHAubGlzdGVuKCk7XG4gICAgICAgIGF3YWl0IHN0cmVhbS5saXN0ZW5lclJ0Y3AubGlzdGVuKCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIE9uZSBvciB0d28gb2YgdGhlIHBvcnRzIHdhcyBpbiB1c2UsIGN5Y2xlIHRoZW0gb3V0IGFuZCB0cnkgYW5vdGhlclxuICAgICAgICBpZiAoZS5lcnJubyAmJiBlLmVycm5vID09PSAnRUFERFJJTlVTRScpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oYFBvcnQgZXJyb3Igb24gJHtlLnBvcnR9LCBmb3Igc3RyZWFtICR7c3RyZWFtLmlkfSB1c2luZyBhbm90aGVyIHBvcnRgKTtcbiAgICAgICAgICBwb3J0RXJyb3IgPSB0cnVlO1xuXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHN0cmVhbS5saXN0ZW5lclJ0cC5jbG9zZSgpO1xuICAgICAgICAgICAgYXdhaXQgc3RyZWFtLmxpc3RlbmVyUnRjcC5jbG9zZSgpO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIC8vIElnbm9yZSwgZG9udCBjYXJlIGlmIGNvdWxkbnQgY2xvc2VcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMubW91bnRzLnJldHVyblJ0cFBvcnRUb1Bvb2woc3RyZWFtLnJ0cFN0YXJ0UG9ydCk7XG4gICAgICAgICAgY29uc3QgbmV4dFN0YXJ0UG9ydCA9IHRoaXMubW91bnRzLmdldE5leHRSdHBQb3J0KCk7XG4gICAgICAgICAgaWYgKCFuZXh0U3RhcnRQb3J0KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBnZXQgYW5vdGhlciBzdGFydCBwb3J0Jyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgc3RyZWFtLnJ0cFN0YXJ0UG9ydCA9IG5leHRTdGFydFBvcnQ7XG4gICAgICAgICAgc3RyZWFtLnJ0cEVuZFBvcnQgPSBzdHJlYW0ucnRwRW5kUG9ydCArIDE7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocG9ydEVycm9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5zZXR1cCgpO1xuICAgIH1cbiAgfVxuXG4gIGNsb3NlICgpIHtcbiAgICBsZXQgcG9ydHMgPSBbXTtcblxuICAgIGZvciAobGV0IGlkIGluIHRoaXMuc3RyZWFtcykge1xuICAgICAgY29uc3Qgc3RyZWFtID0gdGhpcy5zdHJlYW1zW2lkXTtcbiAgICAgIGlmIChzdHJlYW0pIHtcbiAgICAgICAgZm9yIChsZXQgaWQgaW4gc3RyZWFtLmNsaWVudHMpIHtcbiAgICAgICAgICBjb25zdCBjbGllbnQgPSBzdHJlYW0uY2xpZW50c1tpZF07XG4gICAgICAgICAgY29uc29sZS5sb2coJ0Nsb3NpbmcgQ2xpZW50JywgY2xpZW50LmlkKTtcbiAgICAgICAgICBjbGllbnQuY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN0cmVhbS5saXN0ZW5lclJ0cCAmJiBzdHJlYW0ubGlzdGVuZXJSdHAuY2xvc2UoKTtcbiAgICAgICAgc3RyZWFtLmxpc3RlbmVyUnRjcCAmJiBzdHJlYW0ubGlzdGVuZXJSdGNwLmNsb3NlKCk7XG4gICAgICB9XG5cbiAgICAgIHBvcnRzLnB1c2goc3RyZWFtLnJ0cFN0YXJ0UG9ydCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBvcnRzO1xuICB9XG5cbiAgY2xpZW50TGVhdmUgKGNsaWVudDogQ2xpZW50KSB7XG4gICAgZGVsZXRlIHRoaXMuc3RyZWFtc1tjbGllbnQuc3RyZWFtLmlkXS5jbGllbnRzW2NsaWVudC5pZF07XG4gICAgbGV0IGVtcHR5OiBib29sZWFuID0gdHJ1ZTtcbiAgICBmb3IgKGxldCBzdHJlYW0gaW4gdGhpcy5zdHJlYW1zKSB7XG4gICAgICBpZiAoT2JqZWN0LmtleXModGhpcy5zdHJlYW1zW3N0cmVhbV0uY2xpZW50cykubGVuZ3RoID4gMCkge1xuICAgICAgICBlbXB0eSA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChlbXB0eSA9PT0gdHJ1ZSAmJiB0aGlzLmhvb2tzICYmIHRoaXMuaG9va3MubW91bnROb3dFbXB0eSkge1xuICAgICAgdGhpcy5ob29rcy5tb3VudE5vd0VtcHR5KHRoaXMpO1xuICAgIH1cbiAgfVxufVxuIl19