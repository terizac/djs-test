"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClientServer = void 0;

var _basicAuth = require("basic-auth");

var _rtspServer = require("rtsp-server");

var _ClientWrapper = require("./ClientWrapper");

var _utils = require("./utils");

const debug = (0, _utils.getDebugger)('ClientServer');

/**
 *
 */
class ClientServer {
  /**
   *
   * @param rtspPort
   * @param mounts
   */
  constructor(rtspPort, mounts, hooks) {
    this.rtspPort = rtspPort;
    this.mounts = mounts;
    this.clients = {};
    this.hooks = { ...hooks
    };
    this.server = (0, _rtspServer.createServer)((req, res) => {
      debug('%s:%s request: %s %s', req.socket.remoteAddress, req.socket.remotePort, req.method, req.uri);

      switch (req.method) {
        case 'DESCRIBE':
          return this.describeRequest(req, res);

        case 'OPTIONS':
          return this.optionsRequest(req, res);

        case 'SETUP':
          return this.setupRequest(req, res);

        case 'PLAY':
          return this.playRequest(req, res);

        case 'TEARDOWN':
          return this.teardownRequest(req, res);

        default:
          console.error('Unknown ClientServer request', {
            method: req.method,
            url: req.url
          });
          res.statusCode = 501; // Not implemented

          return res.end();
      }
    });
  }

  async start() {
    return new Promise((resolve, reject) => {
      this.server.listen(this.rtspPort, () => {
        debug('Now listening on %s', this.rtspPort);
        return resolve();
      });
    });
  }
  /**
   *
   * @param req
   * @param res
   */


  async optionsRequest(req, res) {
    // Update the client timeout if they provide a session
    if (req.headers.session && (await this.checkAuthenticated(req, res))) {
      const client = this.clients[req.headers.session];

      if (client) {
        client.keepalive();
      } else {
        res.statusCode = 454; // Session not found

        return res.end();
      }
    }

    res.setHeader('OPTIONS', 'DESCRIBE SETUP PLAY STOP');
    return res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async describeRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    } // Hook to set up the mount with a server if required before the client hits it
    // It'll fall through to a 404 regardless


    if (this.hooks.checkMount) {
      const allowed = await this.hooks.checkMount(req);

      if (!allowed || typeof allowed === 'number') {
        debug('%s:%s path not allowed by hook - hook returned: %s', req.socket.remoteAddress, req.socket.remotePort, req.uri, allowed);

        if (typeof allowed === 'number') {
          res.statusCode = allowed;
        } else {
          res.statusCode = 403;
        }

        return res.end();
      }
    }

    const mount = this.mounts.getMount(req.uri);

    if (!mount) {
      debug('%s:%s - Mount not found, sending 404: %o', req.socket.remoteAddress, req.socket.remotePort, req.uri);
      res.statusCode = 404;
      return res.end();
    }

    res.setHeader('Content-Type', 'application/sdp');
    res.setHeader('Content-Length', Buffer.byteLength(mount.sdp));
    res.write(mount.sdp);
    res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async setupRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    } // TCP not supported (yet ;-))


    if (req.headers.transport && req.headers.transport.toLowerCase().indexOf('tcp') > -1) {
      debug('%s:%s - we dont support tcp, sending 461: %o', req.socket.remoteAddress, req.socket.remotePort, req.uri);
      res.statusCode = 461;
      return res.end();
    }

    let clientWrapper;

    if (!req.headers.session) {
      clientWrapper = new _ClientWrapper.ClientWrapper(this, req);
      this.clients[clientWrapper.id] = clientWrapper;
    } else if (this.clients[req.headers.session]) {
      clientWrapper = this.clients[req.headers.session];
    } else {
      return; // This theoretically never reaches, its just to fix TS checks
    }

    res.setHeader('Session', `${clientWrapper.id};timeout=30`);
    const client = clientWrapper.addClient(req);

    try {
      await client.setup(req);
    } catch (e) {
      console.error('Error setting up client', e);
      res.statusCode = 500;
      return res.end();
    }

    res.setHeader('Transport', `${req.headers.transport};server_port=${client.rtpServerPort}-${client.rtcpServerPort}`);
    res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async playRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    }

    if (!req.headers.session || !this.clients[req.headers.session]) {
      debug('%s:%s - session not valid (%s), sending 454: %o', req.socket.remoteAddress, req.socket.remotePort, req.headers.session, req.uri);
      res.statusCode = 454; // Session not valid

      return res.end();
    }

    debug('%s calling play', req.headers.session);
    const client = this.clients[req.headers.session];
    client.play();

    if (client.mount.range) {
      res.setHeader('Range', client.mount.range);
    }

    res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async teardownRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    }

    if (!req.headers.session || !this.clients[req.headers.session]) {
      debug('%s:%s - session not valid (%s), sending 454: %o', req.socket.remoteAddress, req.socket.remotePort, req.headers.session, req.uri);
      res.statusCode = 454;
      return res.end();
    }

    debug('%s:%s tearing down client', req.socket.remoteAddress, req.socket.remotePort);
    const client = this.clients[req.headers.session];
    client.close();
    res.end();
  }
  /**
   *
   * @param clientId
   */


  async clientGone(clientId) {
    if (this.hooks.clientClose) {
      await this.hooks.clientClose(this.clients[clientId].mount);
    }

    debug('ClientWrapper %s gone', clientId);
    delete this.clients[clientId];
  }
  /**
   *
   * @param req
   * @param res
   */


  async checkAuthenticated(req, res) {
    // Ask for authentication
    if (this.hooks.authentication) {
      if (!req.headers.authorization) {
        debug('%s:%s - No authentication information (required), sending 401', req.socket.remoteAddress, req.socket.remotePort);
        res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
        res.statusCode = 401;
        return false;
      } else {
        if (req.headers.session && this.clients[req.headers.session] && this.clients[req.headers.session].authorizationHeader !== req.headers.authorization) {
          debug('%s:%s - session header doesn\'t match the cached value, sending 401', req.socket.remoteAddress, req.socket.remotePort);
          res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
          res.statusCode = 401;
          return false;
        }

        const result = (0, _basicAuth.parse)(req.headers.authorization);

        if (!result) {
          debug('%s:%s - No authentication information (required), sending 401', req.socket.remoteAddress, req.socket.remotePort);
          res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
          res.statusCode = 401;
          return false;
        }

        const allowed = await this.hooks.authentication(result.name, result.pass, req, res);

        if (!allowed) {
          debug('%s:%s - No authentication information (hook returned false), sending 401', req.socket.remoteAddress, req.socket.remotePort);
          res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
          res.statusCode = 401;
          return false;
        }
      }
    }

    return true;
  }

}

exports.ClientServer = ClientServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvQ2xpZW50U2VydmVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwiQ2xpZW50U2VydmVyIiwiY29uc3RydWN0b3IiLCJydHNwUG9ydCIsIm1vdW50cyIsImhvb2tzIiwiY2xpZW50cyIsInNlcnZlciIsInJlcSIsInJlcyIsInNvY2tldCIsInJlbW90ZUFkZHJlc3MiLCJyZW1vdGVQb3J0IiwibWV0aG9kIiwidXJpIiwiZGVzY3JpYmVSZXF1ZXN0Iiwib3B0aW9uc1JlcXVlc3QiLCJzZXR1cFJlcXVlc3QiLCJwbGF5UmVxdWVzdCIsInRlYXJkb3duUmVxdWVzdCIsImNvbnNvbGUiLCJlcnJvciIsInVybCIsInN0YXR1c0NvZGUiLCJlbmQiLCJzdGFydCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwibGlzdGVuIiwiaGVhZGVycyIsInNlc3Npb24iLCJjaGVja0F1dGhlbnRpY2F0ZWQiLCJjbGllbnQiLCJrZWVwYWxpdmUiLCJzZXRIZWFkZXIiLCJjaGVja01vdW50IiwiYWxsb3dlZCIsIm1vdW50IiwiZ2V0TW91bnQiLCJCdWZmZXIiLCJieXRlTGVuZ3RoIiwic2RwIiwid3JpdGUiLCJ0cmFuc3BvcnQiLCJ0b0xvd2VyQ2FzZSIsImluZGV4T2YiLCJjbGllbnRXcmFwcGVyIiwiQ2xpZW50V3JhcHBlciIsImlkIiwiYWRkQ2xpZW50Iiwic2V0dXAiLCJlIiwicnRwU2VydmVyUG9ydCIsInJ0Y3BTZXJ2ZXJQb3J0IiwicGxheSIsInJhbmdlIiwiY2xvc2UiLCJjbGllbnRHb25lIiwiY2xpZW50SWQiLCJjbGllbnRDbG9zZSIsImF1dGhlbnRpY2F0aW9uIiwiYXV0aG9yaXphdGlvbiIsImF1dGhvcml6YXRpb25IZWFkZXIiLCJyZXN1bHQiLCJuYW1lIiwicGFzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUdBOztBQUVBLE1BQU1BLEtBQUssR0FBRyx3QkFBWSxjQUFaLENBQWQ7O0FBUUE7OztBQUdPLE1BQU1DLFlBQU4sQ0FBbUI7QUFReEI7Ozs7O0FBS0FDLEVBQUFBLFdBQVcsQ0FBRUMsUUFBRixFQUFvQkMsTUFBcEIsRUFBb0NDLEtBQXBDLEVBQXFFO0FBQzlFLFNBQUtGLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkO0FBRUEsU0FBS0UsT0FBTCxHQUFlLEVBQWY7QUFFQSxTQUFLRCxLQUFMLEdBQWEsRUFDWCxHQUFHQTtBQURRLEtBQWI7QUFJQSxTQUFLRSxNQUFMLEdBQWMsOEJBQWEsQ0FBQ0MsR0FBRCxFQUFtQkMsR0FBbkIsS0FBeUM7QUFDbEVULE1BQUFBLEtBQUssQ0FBQyxzQkFBRCxFQUF5QlEsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQXBDLEVBQW1ESCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBOUQsRUFBMEVKLEdBQUcsQ0FBQ0ssTUFBOUUsRUFBc0ZMLEdBQUcsQ0FBQ00sR0FBMUYsQ0FBTDs7QUFDQSxjQUFRTixHQUFHLENBQUNLLE1BQVo7QUFDRSxhQUFLLFVBQUw7QUFDRSxpQkFBTyxLQUFLRSxlQUFMLENBQXFCUCxHQUFyQixFQUEwQkMsR0FBMUIsQ0FBUDs7QUFDRixhQUFLLFNBQUw7QUFDRSxpQkFBTyxLQUFLTyxjQUFMLENBQW9CUixHQUFwQixFQUF5QkMsR0FBekIsQ0FBUDs7QUFDRixhQUFLLE9BQUw7QUFDRSxpQkFBTyxLQUFLUSxZQUFMLENBQWtCVCxHQUFsQixFQUF1QkMsR0FBdkIsQ0FBUDs7QUFDRixhQUFLLE1BQUw7QUFDRSxpQkFBTyxLQUFLUyxXQUFMLENBQWlCVixHQUFqQixFQUFzQkMsR0FBdEIsQ0FBUDs7QUFDRixhQUFLLFVBQUw7QUFDRSxpQkFBTyxLQUFLVSxlQUFMLENBQXFCWCxHQUFyQixFQUEwQkMsR0FBMUIsQ0FBUDs7QUFDRjtBQUNFVyxVQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBYyw4QkFBZCxFQUE4QztBQUFFUixZQUFBQSxNQUFNLEVBQUVMLEdBQUcsQ0FBQ0ssTUFBZDtBQUFzQlMsWUFBQUEsR0FBRyxFQUFFZCxHQUFHLENBQUNjO0FBQS9CLFdBQTlDO0FBQ0FiLFVBQUFBLEdBQUcsQ0FBQ2MsVUFBSixHQUFpQixHQUFqQixDQUZGLENBRXdCOztBQUN0QixpQkFBT2QsR0FBRyxDQUFDZSxHQUFKLEVBQVA7QUFkSjtBQWdCRCxLQWxCYSxDQUFkO0FBbUJEOztBQUVELFFBQU1DLEtBQU4sR0FBOEI7QUFDNUIsV0FBTyxJQUFJQyxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDLFdBQUtyQixNQUFMLENBQVlzQixNQUFaLENBQW1CLEtBQUsxQixRQUF4QixFQUFrQyxNQUFNO0FBQ3RDSCxRQUFBQSxLQUFLLENBQUMscUJBQUQsRUFBd0IsS0FBS0csUUFBN0IsQ0FBTDtBQUVBLGVBQU93QixPQUFPLEVBQWQ7QUFDRCxPQUpEO0FBS0QsS0FOTSxDQUFQO0FBT0Q7QUFFRDs7Ozs7OztBQUtBLFFBQU1YLGNBQU4sQ0FBc0JSLEdBQXRCLEVBQXdDQyxHQUF4QyxFQUEwRTtBQUN4RTtBQUNBLFFBQUlELEdBQUcsQ0FBQ3NCLE9BQUosQ0FBWUMsT0FBWixLQUF1QixNQUFNLEtBQUtDLGtCQUFMLENBQXdCeEIsR0FBeEIsRUFBNkJDLEdBQTdCLENBQTdCLENBQUosRUFBb0U7QUFDbEUsWUFBTXdCLE1BQU0sR0FBRyxLQUFLM0IsT0FBTCxDQUFhRSxHQUFHLENBQUNzQixPQUFKLENBQVlDLE9BQXpCLENBQWY7O0FBQ0EsVUFBSUUsTUFBSixFQUFZO0FBQ1ZBLFFBQUFBLE1BQU0sQ0FBQ0MsU0FBUDtBQUNELE9BRkQsTUFFTztBQUNMekIsUUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCLEdBQWpCLENBREssQ0FDaUI7O0FBQ3RCLGVBQU9kLEdBQUcsQ0FBQ2UsR0FBSixFQUFQO0FBQ0Q7QUFDRjs7QUFFRGYsSUFBQUEsR0FBRyxDQUFDMEIsU0FBSixDQUFjLFNBQWQsRUFBeUIsMEJBQXpCO0FBQ0EsV0FBTzFCLEdBQUcsQ0FBQ2UsR0FBSixFQUFQO0FBQ0Q7QUFFRDs7Ozs7OztBQUtBLFFBQU1ULGVBQU4sQ0FBdUJQLEdBQXZCLEVBQXlDQyxHQUF6QyxFQUEyRTtBQUN6RSxRQUFJLEVBQUMsTUFBTSxLQUFLdUIsa0JBQUwsQ0FBd0J4QixHQUF4QixFQUE2QkMsR0FBN0IsQ0FBUCxDQUFKLEVBQThDO0FBQzVDLGFBQU9BLEdBQUcsQ0FBQ2UsR0FBSixFQUFQO0FBQ0QsS0FId0UsQ0FLekU7QUFDQTs7O0FBQ0EsUUFBSSxLQUFLbkIsS0FBTCxDQUFXK0IsVUFBZixFQUEyQjtBQUN6QixZQUFNQyxPQUFPLEdBQUcsTUFBTSxLQUFLaEMsS0FBTCxDQUFXK0IsVUFBWCxDQUFzQjVCLEdBQXRCLENBQXRCOztBQUNBLFVBQUksQ0FBQzZCLE9BQUQsSUFBWSxPQUFPQSxPQUFQLEtBQW1CLFFBQW5DLEVBQTZDO0FBQzNDckMsUUFBQUEsS0FBSyxDQUFDLG9EQUFELEVBQXVEUSxHQUFHLENBQUNFLE1BQUosQ0FBV0MsYUFBbEUsRUFBaUZILEdBQUcsQ0FBQ0UsTUFBSixDQUFXRSxVQUE1RixFQUF3R0osR0FBRyxDQUFDTSxHQUE1RyxFQUFpSHVCLE9BQWpILENBQUw7O0FBQ0EsWUFBSSxPQUFPQSxPQUFQLEtBQW1CLFFBQXZCLEVBQWlDO0FBQy9CNUIsVUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCYyxPQUFqQjtBQUNELFNBRkQsTUFFTztBQUNMNUIsVUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCLEdBQWpCO0FBQ0Q7O0FBRUQsZUFBT2QsR0FBRyxDQUFDZSxHQUFKLEVBQVA7QUFDRDtBQUNGOztBQUVELFVBQU1jLEtBQUssR0FBRyxLQUFLbEMsTUFBTCxDQUFZbUMsUUFBWixDQUFxQi9CLEdBQUcsQ0FBQ00sR0FBekIsQ0FBZDs7QUFFQSxRQUFJLENBQUN3QixLQUFMLEVBQVk7QUFDVnRDLE1BQUFBLEtBQUssQ0FBQywwQ0FBRCxFQUE2Q1EsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQXhELEVBQXVFSCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBbEYsRUFBOEZKLEdBQUcsQ0FBQ00sR0FBbEcsQ0FBTDtBQUNBTCxNQUFBQSxHQUFHLENBQUNjLFVBQUosR0FBaUIsR0FBakI7QUFDQSxhQUFPZCxHQUFHLENBQUNlLEdBQUosRUFBUDtBQUNEOztBQUVEZixJQUFBQSxHQUFHLENBQUMwQixTQUFKLENBQWMsY0FBZCxFQUE4QixpQkFBOUI7QUFDQTFCLElBQUFBLEdBQUcsQ0FBQzBCLFNBQUosQ0FBYyxnQkFBZCxFQUFnQ0ssTUFBTSxDQUFDQyxVQUFQLENBQWtCSCxLQUFLLENBQUNJLEdBQXhCLENBQWhDO0FBRUFqQyxJQUFBQSxHQUFHLENBQUNrQyxLQUFKLENBQVVMLEtBQUssQ0FBQ0ksR0FBaEI7QUFDQWpDLElBQUFBLEdBQUcsQ0FBQ2UsR0FBSjtBQUNEO0FBRUQ7Ozs7Ozs7QUFLQSxRQUFNUCxZQUFOLENBQW9CVCxHQUFwQixFQUFzQ0MsR0FBdEMsRUFBd0U7QUFDdEUsUUFBSSxFQUFDLE1BQU0sS0FBS3VCLGtCQUFMLENBQXdCeEIsR0FBeEIsRUFBNkJDLEdBQTdCLENBQVAsQ0FBSixFQUE4QztBQUM1QyxhQUFPQSxHQUFHLENBQUNlLEdBQUosRUFBUDtBQUNELEtBSHFFLENBS3RFOzs7QUFDQSxRQUFJaEIsR0FBRyxDQUFDc0IsT0FBSixDQUFZYyxTQUFaLElBQXlCcEMsR0FBRyxDQUFDc0IsT0FBSixDQUFZYyxTQUFaLENBQXNCQyxXQUF0QixHQUFvQ0MsT0FBcEMsQ0FBNEMsS0FBNUMsSUFBcUQsQ0FBQyxDQUFuRixFQUFzRjtBQUNwRjlDLE1BQUFBLEtBQUssQ0FBQyw4Q0FBRCxFQUFpRFEsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQTVELEVBQTJFSCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBdEYsRUFBa0dKLEdBQUcsQ0FBQ00sR0FBdEcsQ0FBTDtBQUNBTCxNQUFBQSxHQUFHLENBQUNjLFVBQUosR0FBaUIsR0FBakI7QUFDQSxhQUFPZCxHQUFHLENBQUNlLEdBQUosRUFBUDtBQUNEOztBQUVELFFBQUl1QixhQUFKOztBQUVBLFFBQUksQ0FBQ3ZDLEdBQUcsQ0FBQ3NCLE9BQUosQ0FBWUMsT0FBakIsRUFBMEI7QUFDeEJnQixNQUFBQSxhQUFhLEdBQUcsSUFBSUMsNEJBQUosQ0FBa0IsSUFBbEIsRUFBd0J4QyxHQUF4QixDQUFoQjtBQUNBLFdBQUtGLE9BQUwsQ0FBYXlDLGFBQWEsQ0FBQ0UsRUFBM0IsSUFBaUNGLGFBQWpDO0FBQ0QsS0FIRCxNQUdPLElBQUksS0FBS3pDLE9BQUwsQ0FBYUUsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUF6QixDQUFKLEVBQXVDO0FBQzVDZ0IsTUFBQUEsYUFBYSxHQUFHLEtBQUt6QyxPQUFMLENBQWFFLEdBQUcsQ0FBQ3NCLE9BQUosQ0FBWUMsT0FBekIsQ0FBaEI7QUFDRCxLQUZNLE1BRUE7QUFDTCxhQURLLENBQ0c7QUFDVDs7QUFFRHRCLElBQUFBLEdBQUcsQ0FBQzBCLFNBQUosQ0FBYyxTQUFkLEVBQTBCLEdBQUVZLGFBQWEsQ0FBQ0UsRUFBRyxhQUE3QztBQUNBLFVBQU1oQixNQUFNLEdBQUdjLGFBQWEsQ0FBQ0csU0FBZCxDQUF3QjFDLEdBQXhCLENBQWY7O0FBRUEsUUFBSTtBQUNGLFlBQU15QixNQUFNLENBQUNrQixLQUFQLENBQWEzQyxHQUFiLENBQU47QUFDRCxLQUZELENBRUUsT0FBTzRDLENBQVAsRUFBVTtBQUNWaEMsTUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWMseUJBQWQsRUFBeUMrQixDQUF6QztBQUNBM0MsTUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCLEdBQWpCO0FBQ0EsYUFBT2QsR0FBRyxDQUFDZSxHQUFKLEVBQVA7QUFDRDs7QUFFRGYsSUFBQUEsR0FBRyxDQUFDMEIsU0FBSixDQUFjLFdBQWQsRUFBNEIsR0FBRTNCLEdBQUcsQ0FBQ3NCLE9BQUosQ0FBWWMsU0FBVSxnQkFBZVgsTUFBTSxDQUFDb0IsYUFBYyxJQUFHcEIsTUFBTSxDQUFDcUIsY0FBZSxFQUFqSDtBQUVBN0MsSUFBQUEsR0FBRyxDQUFDZSxHQUFKO0FBQ0Q7QUFFRDs7Ozs7OztBQUtBLFFBQU1OLFdBQU4sQ0FBbUJWLEdBQW5CLEVBQXFDQyxHQUFyQyxFQUF1RTtBQUNyRSxRQUFJLEVBQUMsTUFBTSxLQUFLdUIsa0JBQUwsQ0FBd0J4QixHQUF4QixFQUE2QkMsR0FBN0IsQ0FBUCxDQUFKLEVBQThDO0FBQzVDLGFBQU9BLEdBQUcsQ0FBQ2UsR0FBSixFQUFQO0FBQ0Q7O0FBRUQsUUFBSSxDQUFDaEIsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUFiLElBQXdCLENBQUMsS0FBS3pCLE9BQUwsQ0FBYUUsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUF6QixDQUE3QixFQUFnRTtBQUM5RC9CLE1BQUFBLEtBQUssQ0FBQyxpREFBRCxFQUFvRFEsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQS9ELEVBQThFSCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBekYsRUFBcUdKLEdBQUcsQ0FBQ3NCLE9BQUosQ0FBWUMsT0FBakgsRUFBMEh2QixHQUFHLENBQUNNLEdBQTlILENBQUw7QUFDQUwsTUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCLEdBQWpCLENBRjhELENBRXhDOztBQUN0QixhQUFPZCxHQUFHLENBQUNlLEdBQUosRUFBUDtBQUNEOztBQUVEeEIsSUFBQUEsS0FBSyxDQUFDLGlCQUFELEVBQW9CUSxHQUFHLENBQUNzQixPQUFKLENBQVlDLE9BQWhDLENBQUw7QUFDQSxVQUFNRSxNQUFNLEdBQUcsS0FBSzNCLE9BQUwsQ0FBYUUsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUF6QixDQUFmO0FBQ0FFLElBQUFBLE1BQU0sQ0FBQ3NCLElBQVA7O0FBRUEsUUFBSXRCLE1BQU0sQ0FBQ0ssS0FBUCxDQUFha0IsS0FBakIsRUFBd0I7QUFDdEIvQyxNQUFBQSxHQUFHLENBQUMwQixTQUFKLENBQWMsT0FBZCxFQUF1QkYsTUFBTSxDQUFDSyxLQUFQLENBQWFrQixLQUFwQztBQUNEOztBQUVEL0MsSUFBQUEsR0FBRyxDQUFDZSxHQUFKO0FBQ0Q7QUFFRDs7Ozs7OztBQUtBLFFBQU1MLGVBQU4sQ0FBdUJYLEdBQXZCLEVBQXlDQyxHQUF6QyxFQUEyRTtBQUN6RSxRQUFJLEVBQUMsTUFBTSxLQUFLdUIsa0JBQUwsQ0FBd0J4QixHQUF4QixFQUE2QkMsR0FBN0IsQ0FBUCxDQUFKLEVBQThDO0FBQzVDLGFBQU9BLEdBQUcsQ0FBQ2UsR0FBSixFQUFQO0FBQ0Q7O0FBRUQsUUFBSSxDQUFDaEIsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUFiLElBQXdCLENBQUMsS0FBS3pCLE9BQUwsQ0FBYUUsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUF6QixDQUE3QixFQUFnRTtBQUM5RC9CLE1BQUFBLEtBQUssQ0FBQyxpREFBRCxFQUFvRFEsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQS9ELEVBQThFSCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBekYsRUFBcUdKLEdBQUcsQ0FBQ3NCLE9BQUosQ0FBWUMsT0FBakgsRUFBMEh2QixHQUFHLENBQUNNLEdBQTlILENBQUw7QUFDQUwsTUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCLEdBQWpCO0FBQ0EsYUFBT2QsR0FBRyxDQUFDZSxHQUFKLEVBQVA7QUFDRDs7QUFFRHhCLElBQUFBLEtBQUssQ0FBQywyQkFBRCxFQUE4QlEsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQXpDLEVBQXdESCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBbkUsQ0FBTDtBQUNBLFVBQU1xQixNQUFNLEdBQUcsS0FBSzNCLE9BQUwsQ0FBYUUsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUF6QixDQUFmO0FBQ0FFLElBQUFBLE1BQU0sQ0FBQ3dCLEtBQVA7QUFFQWhELElBQUFBLEdBQUcsQ0FBQ2UsR0FBSjtBQUNEO0FBRUQ7Ozs7OztBQUlBLFFBQU1rQyxVQUFOLENBQWtCQyxRQUFsQixFQUFtRDtBQUNqRCxRQUFJLEtBQUt0RCxLQUFMLENBQVd1RCxXQUFmLEVBQTRCO0FBQzFCLFlBQU0sS0FBS3ZELEtBQUwsQ0FBV3VELFdBQVgsQ0FBdUIsS0FBS3RELE9BQUwsQ0FBYXFELFFBQWIsRUFBdUJyQixLQUE5QyxDQUFOO0FBQ0Q7O0FBRUR0QyxJQUFBQSxLQUFLLENBQUMsdUJBQUQsRUFBMEIyRCxRQUExQixDQUFMO0FBRUEsV0FBTyxLQUFLckQsT0FBTCxDQUFhcUQsUUFBYixDQUFQO0FBQ0Q7QUFFRDs7Ozs7OztBQUtBLFFBQWMzQixrQkFBZCxDQUFrQ3hCLEdBQWxDLEVBQW9EQyxHQUFwRCxFQUF5RjtBQUN2RjtBQUNBLFFBQUksS0FBS0osS0FBTCxDQUFXd0QsY0FBZixFQUErQjtBQUM3QixVQUFJLENBQUNyRCxHQUFHLENBQUNzQixPQUFKLENBQVlnQyxhQUFqQixFQUFnQztBQUM5QjlELFFBQUFBLEtBQUssQ0FBQywrREFBRCxFQUFrRVEsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQTdFLEVBQTRGSCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBdkcsQ0FBTDtBQUNBSCxRQUFBQSxHQUFHLENBQUMwQixTQUFKLENBQWMsa0JBQWQsRUFBa0Msb0JBQWxDO0FBQ0ExQixRQUFBQSxHQUFHLENBQUNjLFVBQUosR0FBaUIsR0FBakI7QUFDQSxlQUFPLEtBQVA7QUFDRCxPQUxELE1BS087QUFDTCxZQUFJZixHQUFHLENBQUNzQixPQUFKLENBQVlDLE9BQVosSUFBdUIsS0FBS3pCLE9BQUwsQ0FBYUUsR0FBRyxDQUFDc0IsT0FBSixDQUFZQyxPQUF6QixDQUF2QixJQUE0RCxLQUFLekIsT0FBTCxDQUFhRSxHQUFHLENBQUNzQixPQUFKLENBQVlDLE9BQXpCLEVBQWtDZ0MsbUJBQWxDLEtBQTBEdkQsR0FBRyxDQUFDc0IsT0FBSixDQUFZZ0MsYUFBdEksRUFBcUo7QUFDbko5RCxVQUFBQSxLQUFLLENBQUMscUVBQUQsRUFBd0VRLEdBQUcsQ0FBQ0UsTUFBSixDQUFXQyxhQUFuRixFQUFrR0gsR0FBRyxDQUFDRSxNQUFKLENBQVdFLFVBQTdHLENBQUw7QUFDQUgsVUFBQUEsR0FBRyxDQUFDMEIsU0FBSixDQUFjLGtCQUFkLEVBQWtDLG9CQUFsQztBQUNBMUIsVUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCLEdBQWpCO0FBQ0EsaUJBQU8sS0FBUDtBQUNEOztBQUVELGNBQU15QyxNQUFNLEdBQUcsc0JBQU14RCxHQUFHLENBQUNzQixPQUFKLENBQVlnQyxhQUFsQixDQUFmOztBQUNBLFlBQUksQ0FBQ0UsTUFBTCxFQUFhO0FBQ1hoRSxVQUFBQSxLQUFLLENBQUMsK0RBQUQsRUFBa0VRLEdBQUcsQ0FBQ0UsTUFBSixDQUFXQyxhQUE3RSxFQUE0RkgsR0FBRyxDQUFDRSxNQUFKLENBQVdFLFVBQXZHLENBQUw7QUFDQUgsVUFBQUEsR0FBRyxDQUFDMEIsU0FBSixDQUFjLGtCQUFkLEVBQWtDLG9CQUFsQztBQUNBMUIsVUFBQUEsR0FBRyxDQUFDYyxVQUFKLEdBQWlCLEdBQWpCO0FBQ0EsaUJBQU8sS0FBUDtBQUNEOztBQUVELGNBQU1jLE9BQU8sR0FBRyxNQUFNLEtBQUtoQyxLQUFMLENBQVd3RCxjQUFYLENBQTBCRyxNQUFNLENBQUNDLElBQWpDLEVBQXVDRCxNQUFNLENBQUNFLElBQTlDLEVBQW9EMUQsR0FBcEQsRUFBeURDLEdBQXpELENBQXRCOztBQUNBLFlBQUksQ0FBQzRCLE9BQUwsRUFBYztBQUNackMsVUFBQUEsS0FBSyxDQUFDLDBFQUFELEVBQTZFUSxHQUFHLENBQUNFLE1BQUosQ0FBV0MsYUFBeEYsRUFBdUdILEdBQUcsQ0FBQ0UsTUFBSixDQUFXRSxVQUFsSCxDQUFMO0FBQ0FILFVBQUFBLEdBQUcsQ0FBQzBCLFNBQUosQ0FBYyxrQkFBZCxFQUFrQyxvQkFBbEM7QUFDQTFCLFVBQUFBLEdBQUcsQ0FBQ2MsVUFBSixHQUFpQixHQUFqQjtBQUNBLGlCQUFPLEtBQVA7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsV0FBTyxJQUFQO0FBQ0Q7O0FBeFF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHBhcnNlIH0gZnJvbSAnYmFzaWMtYXV0aCc7XG5pbXBvcnQgeyBjcmVhdGVTZXJ2ZXIsIFJ0c3BSZXF1ZXN0LCBSdHNwUmVzcG9uc2UsIFJ0c3BTZXJ2ZXIgfSBmcm9tICdydHNwLXNlcnZlcic7XG5cbmltcG9ydCB7IENsaWVudFdyYXBwZXIgfSBmcm9tICcuL0NsaWVudFdyYXBwZXInO1xuaW1wb3J0IHsgTW91bnQgfSBmcm9tICcuL01vdW50JztcbmltcG9ydCB7IE1vdW50cyB9IGZyb20gJy4vTW91bnRzJztcbmltcG9ydCB7IGdldERlYnVnZ2VyIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IGRlYnVnID0gZ2V0RGVidWdnZXIoJ0NsaWVudFNlcnZlcicpO1xuXG5leHBvcnQgaW50ZXJmYWNlIENsaWVudFNlcnZlckhvb2tzQ29uZmlnIHtcbiAgYXV0aGVudGljYXRpb24/OiAodXNlcm5hbWU6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgcmVxOiBSdHNwUmVxdWVzdCwgcmVzOiBSdHNwUmVzcG9uc2UpID0+IFByb21pc2U8Ym9vbGVhbj47XG4gIGNoZWNrTW91bnQ/OiAocmVxOiBSdHNwUmVxdWVzdCkgPT4gUHJvbWlzZTxib29sZWFuIHwgbnVtYmVyPjtcbiAgY2xpZW50Q2xvc2U/OiAobW91bnQ6IE1vdW50KSA9PiBQcm9taXNlPHZvaWQ+O1xufVxuXG4vKipcbiAqXG4gKi9cbmV4cG9ydCBjbGFzcyBDbGllbnRTZXJ2ZXIge1xuICBob29rczogQ2xpZW50U2VydmVySG9va3NDb25maWc7XG5cbiAgbW91bnRzOiBNb3VudHM7XG4gIHJ0c3BQb3J0OiBudW1iZXI7XG4gIHNlcnZlcjogUnRzcFNlcnZlcjtcbiAgY2xpZW50czogeyBbc2Vzc2lvbklkOiBzdHJpbmddOiBDbGllbnRXcmFwcGVyIH07XG5cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSBydHNwUG9ydFxuICAgKiBAcGFyYW0gbW91bnRzXG4gICAqL1xuICBjb25zdHJ1Y3RvciAocnRzcFBvcnQ6IG51bWJlciwgbW91bnRzOiBNb3VudHMsIGhvb2tzPzogQ2xpZW50U2VydmVySG9va3NDb25maWcpIHtcbiAgICB0aGlzLnJ0c3BQb3J0ID0gcnRzcFBvcnQ7XG4gICAgdGhpcy5tb3VudHMgPSBtb3VudHM7XG5cbiAgICB0aGlzLmNsaWVudHMgPSB7fTtcblxuICAgIHRoaXMuaG9va3MgPSB7XG4gICAgICAuLi5ob29rc1xuICAgIH07XG5cbiAgICB0aGlzLnNlcnZlciA9IGNyZWF0ZVNlcnZlcigocmVxOiBSdHNwUmVxdWVzdCwgcmVzOiBSdHNwUmVzcG9uc2UpID0+IHtcbiAgICAgIGRlYnVnKCclczolcyByZXF1ZXN0OiAlcyAlcycsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0LCByZXEubWV0aG9kLCByZXEudXJpKTtcbiAgICAgIHN3aXRjaCAocmVxLm1ldGhvZCkge1xuICAgICAgICBjYXNlICdERVNDUklCRSc6XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZGVzY3JpYmVSZXF1ZXN0KHJlcSwgcmVzKTtcbiAgICAgICAgY2FzZSAnT1BUSU9OUyc6XG4gICAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9uc1JlcXVlc3QocmVxLCByZXMpO1xuICAgICAgICBjYXNlICdTRVRVUCc6XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2V0dXBSZXF1ZXN0KHJlcSwgcmVzKTtcbiAgICAgICAgY2FzZSAnUExBWSc6XG4gICAgICAgICAgcmV0dXJuIHRoaXMucGxheVJlcXVlc3QocmVxLCByZXMpO1xuICAgICAgICBjYXNlICdURUFSRE9XTic6XG4gICAgICAgICAgcmV0dXJuIHRoaXMudGVhcmRvd25SZXF1ZXN0KHJlcSwgcmVzKTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdVbmtub3duIENsaWVudFNlcnZlciByZXF1ZXN0JywgeyBtZXRob2Q6IHJlcS5tZXRob2QsIHVybDogcmVxLnVybCB9KTtcbiAgICAgICAgICByZXMuc3RhdHVzQ29kZSA9IDUwMTsgLy8gTm90IGltcGxlbWVudGVkXG4gICAgICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5zZXJ2ZXIubGlzdGVuKHRoaXMucnRzcFBvcnQsICgpID0+IHtcbiAgICAgICAgZGVidWcoJ05vdyBsaXN0ZW5pbmcgb24gJXMnLCB0aGlzLnJ0c3BQb3J0KTtcblxuICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHJlcVxuICAgKiBAcGFyYW0gcmVzXG4gICAqL1xuICBhc3luYyBvcHRpb25zUmVxdWVzdCAocmVxOiBSdHNwUmVxdWVzdCwgcmVzOiBSdHNwUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBVcGRhdGUgdGhlIGNsaWVudCB0aW1lb3V0IGlmIHRoZXkgcHJvdmlkZSBhIHNlc3Npb25cbiAgICBpZiAocmVxLmhlYWRlcnMuc2Vzc2lvbiAmJiBhd2FpdCB0aGlzLmNoZWNrQXV0aGVudGljYXRlZChyZXEsIHJlcykpIHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXTtcbiAgICAgIGlmIChjbGllbnQpIHtcbiAgICAgICAgY2xpZW50LmtlZXBhbGl2ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0NTQ7IC8vIFNlc3Npb24gbm90IGZvdW5kXG4gICAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmVzLnNldEhlYWRlcignT1BUSU9OUycsICdERVNDUklCRSBTRVRVUCBQTEFZIFNUT1AnKTtcbiAgICByZXR1cm4gcmVzLmVuZCgpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSByZXFcbiAgICogQHBhcmFtIHJlc1xuICAgKi9cbiAgYXN5bmMgZGVzY3JpYmVSZXF1ZXN0IChyZXE6IFJ0c3BSZXF1ZXN0LCByZXM6IFJ0c3BSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghYXdhaXQgdGhpcy5jaGVja0F1dGhlbnRpY2F0ZWQocmVxLCByZXMpKSB7XG4gICAgICByZXR1cm4gcmVzLmVuZCgpO1xuICAgIH1cblxuICAgIC8vIEhvb2sgdG8gc2V0IHVwIHRoZSBtb3VudCB3aXRoIGEgc2VydmVyIGlmIHJlcXVpcmVkIGJlZm9yZSB0aGUgY2xpZW50IGhpdHMgaXRcbiAgICAvLyBJdCdsbCBmYWxsIHRocm91Z2ggdG8gYSA0MDQgcmVnYXJkbGVzc1xuICAgIGlmICh0aGlzLmhvb2tzLmNoZWNrTW91bnQpIHtcbiAgICAgIGNvbnN0IGFsbG93ZWQgPSBhd2FpdCB0aGlzLmhvb2tzLmNoZWNrTW91bnQocmVxKTtcbiAgICAgIGlmICghYWxsb3dlZCB8fCB0eXBlb2YgYWxsb3dlZCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgZGVidWcoJyVzOiVzIHBhdGggbm90IGFsbG93ZWQgYnkgaG9vayAtIGhvb2sgcmV0dXJuZWQ6ICVzJywgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzLCByZXEuc29ja2V0LnJlbW90ZVBvcnQsIHJlcS51cmksIGFsbG93ZWQpO1xuICAgICAgICBpZiAodHlwZW9mIGFsbG93ZWQgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSBhbGxvd2VkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gNDAzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBtb3VudCA9IHRoaXMubW91bnRzLmdldE1vdW50KHJlcS51cmkpO1xuXG4gICAgaWYgKCFtb3VudCkge1xuICAgICAgZGVidWcoJyVzOiVzIC0gTW91bnQgbm90IGZvdW5kLCBzZW5kaW5nIDQwNDogJW8nLCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MsIHJlcS5zb2NrZXQucmVtb3RlUG9ydCwgcmVxLnVyaSk7XG4gICAgICByZXMuc3RhdHVzQ29kZSA9IDQwNDtcbiAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3NkcCcpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtTGVuZ3RoJywgQnVmZmVyLmJ5dGVMZW5ndGgobW91bnQuc2RwKSk7XG5cbiAgICByZXMud3JpdGUobW91bnQuc2RwKTtcbiAgICByZXMuZW5kKCk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHJlcVxuICAgKiBAcGFyYW0gcmVzXG4gICAqL1xuICBhc3luYyBzZXR1cFJlcXVlc3QgKHJlcTogUnRzcFJlcXVlc3QsIHJlczogUnRzcFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFhd2FpdCB0aGlzLmNoZWNrQXV0aGVudGljYXRlZChyZXEsIHJlcykpIHtcbiAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgLy8gVENQIG5vdCBzdXBwb3J0ZWQgKHlldCA7LSkpXG4gICAgaWYgKHJlcS5oZWFkZXJzLnRyYW5zcG9ydCAmJiByZXEuaGVhZGVycy50cmFuc3BvcnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCd0Y3AnKSA+IC0xKSB7XG4gICAgICBkZWJ1ZygnJXM6JXMgLSB3ZSBkb250IHN1cHBvcnQgdGNwLCBzZW5kaW5nIDQ2MTogJW8nLCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MsIHJlcS5zb2NrZXQucmVtb3RlUG9ydCwgcmVxLnVyaSk7XG4gICAgICByZXMuc3RhdHVzQ29kZSA9IDQ2MTtcbiAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgbGV0IGNsaWVudFdyYXBwZXI6IENsaWVudFdyYXBwZXI7XG5cbiAgICBpZiAoIXJlcS5oZWFkZXJzLnNlc3Npb24pIHtcbiAgICAgIGNsaWVudFdyYXBwZXIgPSBuZXcgQ2xpZW50V3JhcHBlcih0aGlzLCByZXEpO1xuICAgICAgdGhpcy5jbGllbnRzW2NsaWVudFdyYXBwZXIuaWRdID0gY2xpZW50V3JhcHBlcjtcbiAgICB9IGVsc2UgaWYgKHRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXSkge1xuICAgICAgY2xpZW50V3JhcHBlciA9IHRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuOyAvLyBUaGlzIHRoZW9yZXRpY2FsbHkgbmV2ZXIgcmVhY2hlcywgaXRzIGp1c3QgdG8gZml4IFRTIGNoZWNrc1xuICAgIH1cblxuICAgIHJlcy5zZXRIZWFkZXIoJ1Nlc3Npb24nLCBgJHtjbGllbnRXcmFwcGVyLmlkfTt0aW1lb3V0PTMwYCk7XG4gICAgY29uc3QgY2xpZW50ID0gY2xpZW50V3JhcHBlci5hZGRDbGllbnQocmVxKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjbGllbnQuc2V0dXAocmVxKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzZXR0aW5nIHVwIGNsaWVudCcsIGUpO1xuICAgICAgcmVzLnN0YXR1c0NvZGUgPSA1MDA7XG4gICAgICByZXR1cm4gcmVzLmVuZCgpO1xuICAgIH1cblxuICAgIHJlcy5zZXRIZWFkZXIoJ1RyYW5zcG9ydCcsIGAke3JlcS5oZWFkZXJzLnRyYW5zcG9ydH07c2VydmVyX3BvcnQ9JHtjbGllbnQucnRwU2VydmVyUG9ydH0tJHtjbGllbnQucnRjcFNlcnZlclBvcnR9YCk7XG5cbiAgICByZXMuZW5kKCk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHJlcVxuICAgKiBAcGFyYW0gcmVzXG4gICAqL1xuICBhc3luYyBwbGF5UmVxdWVzdCAocmVxOiBSdHNwUmVxdWVzdCwgcmVzOiBSdHNwUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuY2hlY2tBdXRoZW50aWNhdGVkKHJlcSwgcmVzKSkge1xuICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlcS5oZWFkZXJzLnNlc3Npb24gfHwgIXRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXSkge1xuICAgICAgZGVidWcoJyVzOiVzIC0gc2Vzc2lvbiBub3QgdmFsaWQgKCVzKSwgc2VuZGluZyA0NTQ6ICVvJywgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzLCByZXEuc29ja2V0LnJlbW90ZVBvcnQsIHJlcS5oZWFkZXJzLnNlc3Npb24sIHJlcS51cmkpO1xuICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0NTQ7IC8vIFNlc3Npb24gbm90IHZhbGlkXG4gICAgICByZXR1cm4gcmVzLmVuZCgpO1xuICAgIH1cblxuICAgIGRlYnVnKCclcyBjYWxsaW5nIHBsYXknLCByZXEuaGVhZGVycy5zZXNzaW9uKTtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmNsaWVudHNbcmVxLmhlYWRlcnMuc2Vzc2lvbl07XG4gICAgY2xpZW50LnBsYXkoKTtcblxuICAgIGlmIChjbGllbnQubW91bnQucmFuZ2UpIHtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ1JhbmdlJywgY2xpZW50Lm1vdW50LnJhbmdlKTtcbiAgICB9XG5cbiAgICByZXMuZW5kKCk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHJlcVxuICAgKiBAcGFyYW0gcmVzXG4gICAqL1xuICBhc3luYyB0ZWFyZG93blJlcXVlc3QgKHJlcTogUnRzcFJlcXVlc3QsIHJlczogUnRzcFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFhd2FpdCB0aGlzLmNoZWNrQXV0aGVudGljYXRlZChyZXEsIHJlcykpIHtcbiAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgaWYgKCFyZXEuaGVhZGVycy5zZXNzaW9uIHx8ICF0aGlzLmNsaWVudHNbcmVxLmhlYWRlcnMuc2Vzc2lvbl0pIHtcbiAgICAgIGRlYnVnKCclczolcyAtIHNlc3Npb24gbm90IHZhbGlkICglcyksIHNlbmRpbmcgNDU0OiAlbycsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0LCByZXEuaGVhZGVycy5zZXNzaW9uLCByZXEudXJpKTtcbiAgICAgIHJlcy5zdGF0dXNDb2RlID0gNDU0O1xuICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICBkZWJ1ZygnJXM6JXMgdGVhcmluZyBkb3duIGNsaWVudCcsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0KTtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmNsaWVudHNbcmVxLmhlYWRlcnMuc2Vzc2lvbl07XG4gICAgY2xpZW50LmNsb3NlKCk7XG5cbiAgICByZXMuZW5kKCk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIGNsaWVudElkXG4gICAqL1xuICBhc3luYyBjbGllbnRHb25lIChjbGllbnRJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuaG9va3MuY2xpZW50Q2xvc2UpIHtcbiAgICAgIGF3YWl0IHRoaXMuaG9va3MuY2xpZW50Q2xvc2UodGhpcy5jbGllbnRzW2NsaWVudElkXS5tb3VudCk7XG4gICAgfVxuXG4gICAgZGVidWcoJ0NsaWVudFdyYXBwZXIgJXMgZ29uZScsIGNsaWVudElkKTtcblxuICAgIGRlbGV0ZSB0aGlzLmNsaWVudHNbY2xpZW50SWRdO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSByZXFcbiAgICogQHBhcmFtIHJlc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjaGVja0F1dGhlbnRpY2F0ZWQgKHJlcTogUnRzcFJlcXVlc3QsIHJlczogUnRzcFJlc3BvbnNlKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQXNrIGZvciBhdXRoZW50aWNhdGlvblxuICAgIGlmICh0aGlzLmhvb2tzLmF1dGhlbnRpY2F0aW9uKSB7XG4gICAgICBpZiAoIXJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24pIHtcbiAgICAgICAgZGVidWcoJyVzOiVzIC0gTm8gYXV0aGVudGljYXRpb24gaW5mb3JtYXRpb24gKHJlcXVpcmVkKSwgc2VuZGluZyA0MDEnLCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MsIHJlcS5zb2NrZXQucmVtb3RlUG9ydCk7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1dXVy1BdXRoZW50aWNhdGUnLCAnQmFzaWMgcmVhbG09XCJydHNwXCInKTtcbiAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0MDE7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChyZXEuaGVhZGVycy5zZXNzaW9uICYmIHRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXSAmJiB0aGlzLmNsaWVudHNbcmVxLmhlYWRlcnMuc2Vzc2lvbl0uYXV0aG9yaXphdGlvbkhlYWRlciAhPT0gcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbikge1xuICAgICAgICAgIGRlYnVnKCclczolcyAtIHNlc3Npb24gaGVhZGVyIGRvZXNuXFwndCBtYXRjaCB0aGUgY2FjaGVkIHZhbHVlLCBzZW5kaW5nIDQwMScsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0KTtcbiAgICAgICAgICByZXMuc2V0SGVhZGVyKCdXV1ctQXV0aGVudGljYXRlJywgJ0Jhc2ljIHJlYWxtPVwicnRzcFwiJyk7XG4gICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0MDE7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2UocmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbik7XG4gICAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgICAgZGVidWcoJyVzOiVzIC0gTm8gYXV0aGVudGljYXRpb24gaW5mb3JtYXRpb24gKHJlcXVpcmVkKSwgc2VuZGluZyA0MDEnLCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MsIHJlcS5zb2NrZXQucmVtb3RlUG9ydCk7XG4gICAgICAgICAgcmVzLnNldEhlYWRlcignV1dXLUF1dGhlbnRpY2F0ZScsICdCYXNpYyByZWFsbT1cInJ0c3BcIicpO1xuICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gNDAxO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGFsbG93ZWQgPSBhd2FpdCB0aGlzLmhvb2tzLmF1dGhlbnRpY2F0aW9uKHJlc3VsdC5uYW1lLCByZXN1bHQucGFzcywgcmVxLCByZXMpO1xuICAgICAgICBpZiAoIWFsbG93ZWQpIHtcbiAgICAgICAgICBkZWJ1ZygnJXM6JXMgLSBObyBhdXRoZW50aWNhdGlvbiBpbmZvcm1hdGlvbiAoaG9vayByZXR1cm5lZCBmYWxzZSksIHNlbmRpbmcgNDAxJywgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzLCByZXEuc29ja2V0LnJlbW90ZVBvcnQpO1xuICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ1dXVy1BdXRoZW50aWNhdGUnLCAnQmFzaWMgcmVhbG09XCJydHNwXCInKTtcbiAgICAgICAgICByZXMuc3RhdHVzQ29kZSA9IDQwMTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuIl19